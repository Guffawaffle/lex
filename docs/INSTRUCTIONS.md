# Instructions Generation

> **Generate and sync AI assistant instructions across your repository.**

The Lex instructions feature maintains a **single source of truth** for AI assistant guidance, automatically projecting it to host-specific files like `.github/copilot-instructions.md` and `.cursorrules`.

---

## Quick Start

Get started in 3 commands:

```bash
# 1. Initialize workspace (if not already done)
lex init

# 2. Create your canonical instruction file
# Edit: .smartergpt/instructions/lex.md

# 3. Generate projections to host files
lex instructions generate
```

That's it! Your instructions are now synced to detected host files.

---

## How It Works

```
┌─────────────────────────────────────────┐
│  .smartergpt/instructions/lex.md        │  ← Canonical Source (you edit this)
│  (Single source of truth)               │
└─────────────────────────────────────────┘
                    │
                    │ lex instructions generate
                    ▼
┌─────────────────────────────────────────┐
│  Host Files (auto-detected)             │
│                                         │
│  • .github/copilot-instructions.md      │  ← GitHub Copilot
│  • .cursorrules                         │  ← Cursor IDE
└─────────────────────────────────────────┘
```

**Key principles:**
- **Single source:** Edit `.smartergpt/instructions/lex.md` only
- **Deterministic:** Same repo state + same Lex version = identical output
- **Safe:** Content outside Lex markers is never modified
- **Model-agnostic:** No vendor-specific language (GPT, Claude, etc.)

---

## Configuration Reference

### lex.yaml

Configuration is optional. Without `lex.yaml`, Lex uses sensible defaults with auto-detection.

```yaml
# lex.yaml - Lex Configuration
version: 1

instructions:
  # Where to read canonical instructions from
  # Default: .smartergpt/instructions/lex.md
  canonical: .smartergpt/instructions/lex.md

  # Which hosts to project to (auto-detected if omitted)
  projections:
    copilot: true   # .github/copilot-instructions.md
    cursor: true    # .cursorrules
```

### Configuration Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `version` | number | `1` | Config schema version |
| `instructions.canonical` | string | `.smartergpt/instructions/lex.md` | Path to canonical instruction file |
| `instructions.projections.copilot` | boolean | `true` | Enable GitHub Copilot projection |
| `instructions.projections.cursor` | boolean | `true` | Enable Cursor IDE projection |

### Example: Disable Cursor Projection

```yaml
version: 1

instructions:
  projections:
    copilot: true
    cursor: false  # Don't project to .cursorrules
```

---

## Host Detection

Lex auto-detects which hosts are available in your repository:

| Host | Detection Rule | Target File |
|------|---------------|-------------|
| **Copilot** | `.github/` directory exists | `.github/copilot-instructions.md` |
| **Cursor** | `.cursorrules` file exists | `.cursorrules` |

### Detection Behavior

- **Copilot:** If `.github/` exists, Lex will create or update `.github/copilot-instructions.md`
- **Cursor:** Only updates if `.cursorrules` already exists (won't create new file)

### Override Auto-Detection

Use `lex.yaml` to explicitly enable or disable hosts:

```yaml
version: 1

instructions:
  projections:
    copilot: true   # Always project (if .github/ exists)
    cursor: false   # Never project
```

---

## Marker System

Lex uses HTML comment markers to identify and update its content within host files:

```markdown
<!-- LEX:BEGIN -->
<!-- This block is auto-generated by `lex instructions generate`. Do not edit manually. -->

[Your instruction content here]

<!-- LEX:END -->
```

### How Markers Work

1. **Content inside markers** is fully managed by Lex and regenerated on each run
2. **Content outside markers** is preserved exactly as-is
3. **No markers found?** Content is appended at the end of the file

### Example: Mixed Content

You can have custom content alongside Lex-managed content:

```markdown
# My Custom Header

This content is mine and won't be touched by Lex.

<!-- LEX:BEGIN -->
<!-- This block is auto-generated by `lex instructions generate`. Do not edit manually. -->

## Lex Instructions

Content from .smartergpt/instructions/lex.md

<!-- LEX:END -->

## My Custom Footer

More custom content that Lex preserves.
```

### Marker Invariants

- Markers must appear in order: `LEX:BEGIN` before `LEX:END`
- Only one marker pair per file
- Malformed markers are treated as "no markers found"

---

## CLI Reference

### lex instructions generate

Generate instruction projections from canonical source.

```bash
lex instructions generate [options]
```

**Options:**

| Flag | Description |
|------|-------------|
| `--dry-run` | Show what would be written without writing files |
| `--json` | Output results as JSON |
| `--repo <path>` | Target repository path (default: current directory) |

**Exit Codes:**

| Code | Meaning |
|------|---------|
| `0` | Success |
| `1` | System error (I/O, permissions) |
| `2` | Validation error (bad config) |

**Examples:**

```bash
# Generate with preview
lex instructions generate --dry-run

# Generate with JSON output
lex instructions generate --json

# Generate for specific repository
lex instructions generate --repo /path/to/repo
```

---

## Canonical File Format

The canonical instruction file at `.smartergpt/instructions/lex.md` should follow this structure:

```markdown
# Lex Instructions

## What Lex Does in This Repository

[Description of Lex's role and capabilities in your project]

## Key Files

| File | Purpose |
|------|---------|
| `lexmap.policy.json` | Module ownership and dependency policy |
| `lex.yaml` | Configuration for instruction generation |

## Situational Guidance

### When Planning Work
[Guidance for the planning phase]

### When Editing Code
[Guidance for code editing]

### When Reviewing
[Guidance for code review]

## Memory Commands

\`\`\`bash
lex remember --reference-point "..." --summary "..."
lex recall "query"
lex timeline
\`\`\`
```

### Content Guidelines

**Do include:**
- Repository-specific conventions
- Module boundaries and ownership rules
- CLI commands and workflows
- Links to important documentation

**Do NOT include:**
- Model-specific references (GPT, Claude, Gemini, etc.)
- Timestamps or dates (breaks determinism)
- Environment-specific paths (absolute paths, user directories)
- Sensitive information (API keys, credentials)

---

## Troubleshooting

### No projections generated

**Symptoms:** `lex instructions generate` completes but no files are created/updated.

**Possible causes:**

1. **Canonical file doesn't exist**
   ```bash
   # Check if canonical file exists
   ls -la .smartergpt/instructions/lex.md
   ```

2. **No hosts detected**
   ```bash
   # Check for .github directory (Copilot)
   ls -la .github/
   
   # Check for .cursorrules (Cursor)
   ls -la .cursorrules
   ```

3. **Projections disabled in config**
   ```bash
   # Check lex.yaml configuration
   cat lex.yaml
   ```

### Content not updating

**Symptoms:** Changes to canonical file don't appear in host files.

**Solutions:**

1. **Verify canonical file is saved**
2. **Check for YAML syntax errors in lex.yaml**
3. **Ensure markers are not malformed in host files**

### Markers corrupted

**Symptoms:** Lex appends content instead of replacing.

**Solution:** Fix or remove malformed markers:
```bash
# Check marker format
grep -n "LEX:BEGIN\|LEX:END" .github/copilot-instructions.md
```

Valid markers look like:
```markdown
<!-- LEX:BEGIN -->
...
<!-- LEX:END -->
```

### Permission denied

**Symptoms:** Error writing to host files.

**Solution:** Check file permissions:
```bash
ls -la .github/copilot-instructions.md
chmod 644 .github/copilot-instructions.md
```

### Config validation errors

**Symptoms:** "Validation error" exit code (2).

**Common issues:**

1. **Invalid YAML syntax**
   ```bash
   # Validate YAML
   npx yaml-lint lex.yaml
   ```

2. **Unknown fields** (strict mode)
   - Remove unrecognized fields from `lex.yaml`

3. **Invalid projection values**
   - Projection values must be `true` or `false`

---

## Best Practices

### Version Control

- **Commit the canonical file** (`.smartergpt/instructions/lex.md`)
- **Commit lex.yaml** if customized
- **Optionally commit host files** or regenerate in CI

### CI Integration

Add instruction generation to your CI pipeline:

```yaml
# .github/workflows/instructions.yml
name: Sync Instructions

on:
  push:
    paths:
      - '.smartergpt/instructions/**'
      - 'lex.yaml'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @smartergpt/lex
      - run: lex instructions generate
      - run: git diff --exit-code || echo "Instructions out of sync!"
```

### Keep Instructions Focused

- Focus on **what matters for AI assistants**
- Reference detailed docs rather than duplicating content
- Update when architectural decisions change

---

## See Also

- [Quick Start Guide](../QUICK_START.md)
- [lex.yaml Configuration Contract](./specs/lex-yaml-config-contract.md)
- [Canonical Instruction Format Specification](./specs/canonical-instruction-format.md)
- [Instructions Contract](./specs/lex-2.0.0-instructions-contract.md)
