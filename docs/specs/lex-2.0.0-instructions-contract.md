# Lex 2.0.0 Instructions Contract

> **Status:** Draft — awaiting `[signed ~]`
> **Version:** 2.0.0
> **Created:** 2025-11-29
> **Parent Issue:** #415

---

## Overview

This contract defines the promises and boundaries for the `lex instructions generate` command in Lex 2.0.0. It establishes the **canonical + projection** model where Lex becomes the authoritative source of AI assistant guidance in a repository.

---

## Hard Promises

### 1. Canonical Source of Truth

Lex-generated instructions live in `.smartergpt/instructions/lex.md`. This file is the **single source**; host files receive projections.

**Invariant:** All projected content derives from the canonical file. The canonical file is always regenerated in full.

### 2. Marker-Based Ownership

Lex only touches content inside `<!-- LEX:BEGIN -->` / `<!-- LEX:END -->` markers in host files.

**Invariant:** Content outside markers is **never** modified, moved, or deleted by Lex.

### 3. Deterministic Generation

Same repo state + same Lex version → identical output.

**Invariant:** No timestamps, random values, or environment-dependent content in generated output that would cause spurious diffs.

### 4. Backwards Compatibility

Repos without `lex.yaml` continue to work. Existing 1.x commands (`lex remember`, `lex recall`, `lex check`, etc.) are unchanged.

**Invariant:** A 1.x repo with no config changes will pass all existing tests after upgrading to 2.0.0.

### 5. Model-Agnostic

Generated instructions never reference specific models (GPT, Claude, Gemini, etc.).

**Invariant:** The strings "GPT", "Claude", "Gemini", "OpenAI", "Anthropic", "Google" do not appear in generated content.

### 6. Mode-Agnostic

Generated instructions never reference personas or modes (Senior Dev, Eager PM, etc.).

**Invariant:** Those belong in orchestrators (e.g., lex-pr-runner), not Lex core.

### 7. `lex.yaml` is Optional

Config file enables customization but is not required for basic functionality.

**Invariant:** `lex instructions generate` works with sensible defaults when `lex.yaml` is absent.

---

## Explicit Non-Goals (2.0.0)

These are **not** part of 2.0.0 scope:

| Item | Reason |
|------|--------|
| Mode-aware generation | Belongs in orchestrators (lex-pr-runner) |
| Sysenv-conditional projection | Acknowledged but not exploited yet |
| Path-specific instructions | Adds complexity, defer to 2.1.0 |
| `AGENTS.md` generation | Emerging standard, not stable enough |
| Cross-repo syncing | Monorepo support is significant complexity |
| Custom block templates | User-defined templates are future scope |
| `lex instructions verify` | CI verification is useful but not blocking |

---

## Interface Contract

### CLI Command

```bash
lex instructions generate [options]
```

### Options

| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `--dry-run` | boolean | `false` | Show diff without writing files |
| `--json` | boolean | `false` | Output results as JSON |
| `--repo` | string | `.` | Target repository path |

### Exit Codes

| Code | Meaning |
|------|---------|
| `0` | Success (files written or would be written) |
| `1` | System error (I/O, permissions) |
| `2` | Validation error (bad config) |

### Output Files

| File | Purpose | Always Created |
|------|---------|----------------|
| `.smartergpt/instructions/lex.md` | Canonical source | Yes |
| `.github/copilot-instructions.md` | Projection (if `.github/` exists) | Conditional |
| `.cursorrules` | Projection (if file exists) | Conditional |

---

## File Format: Canonical Source

```markdown
---
lex_version: "2.0.0"
generated_by: "lex instructions generate"
---

# Lex Instructions for [repo-name]

## What Lex Does in This Repository

[Generated description of Lex's role]

## Key Files

- `lexmap.policy.json` — Module ownership map
- `**/CONTRACT.md` — Frozen interface contracts
- `.smartergpt/` — Local workspace (gitignored)

## Situational Guidance

### When Planning Work
[Generated guidance]

### When Editing Code
[Generated guidance]

### When Reviewing
[Generated guidance]

## Memory Commands

```bash
lex remember --reference-point "..." --summary "..."
lex recall "query"
lex timeline
```
```

---

## File Format: Projected Block

```markdown
<!-- LEX:BEGIN -->
<!-- Auto-generated by `lex instructions generate`. Edit via Lex, not by hand. -->

[Content projected from .smartergpt/instructions/lex.md]

<!-- LEX:END -->
```

---

## Acceptance Criteria

- [ ] `lex instructions generate` creates `.smartergpt/instructions/lex.md`
- [ ] Detected hosts receive projected blocks with markers
- [ ] `--dry-run` shows diff without writing
- [ ] Running twice produces identical output (determinism)
- [ ] 1.x repos pass existing test suite without changes
- [ ] Generated content passes model-agnostic check (no vendor names)
- [ ] Generated content passes mode-agnostic check (no persona names)
- [ ] Content outside markers is preserved on regeneration

---

## Change Protocol

Changes to this contract require:

1. [ ] Discussion in parent issue (#415)
2. [ ] Version bump (SemVer)
3. [ ] Chief Architect explicit approval
4. [ ] Updated tests covering new behavior

---

## Signatures

**Guff**
`[awaiting signature]`

**Lex**
`[signed Lex ✶]` (pending Guff's signature)
