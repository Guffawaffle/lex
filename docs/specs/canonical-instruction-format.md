# Canonical Instruction Format Specification

**Status:** Accepted
**Version:** 1.0.0
**Last Updated:** 2025-11-29
**Parent Issue:** #416

## Overview

This specification defines the format and structure for the canonical instruction file at `.smartergpt/instructions/lex.md`. This file serves as the **single source of truth** for all AI assistant guidance generated by Lex in a repository.

## File Location

```
.smartergpt/instructions/lex.md
```

**Directory:** `.smartergpt/instructions/`
**Filename:** `lex.md`
**Encoding:** UTF-8
**Line endings:** LF (Unix-style)

## File Structure

The canonical instruction file consists of two parts:

1. **YAML Frontmatter** (required) — Metadata about the file
2. **Markdown Body** (required) — The instruction content

### YAML Frontmatter

The file MUST begin with YAML frontmatter delimited by `---`:

```yaml
---
lex_version: "2.0.0"
generated_by: "lex instructions generate"
schema_version: "1"
---
```

#### Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `lex_version` | string | The Lex version that generated this file (SemVer format) |
| `generated_by` | string | The command that generated this file |
| `schema_version` | string | The schema version for this format (for future compatibility) |

#### Reserved Fields (Future Use)

| Field | Type | Description |
|-------|------|-------------|
| `generated_at` | ISO 8601 datetime | **NOT RECOMMENDED** — Causes non-deterministic output |
| `repo_name` | string | Repository name (if needed for multi-repo scenarios) |

### Markdown Body

The body follows standard Markdown syntax with these sections:

```markdown
# Lex Instructions

## What Lex Does in This Repository

[Description of Lex's role and capabilities]

## Key Files

[List of important Lex-related files]

## Situational Guidance

### When Planning Work
[Guidance for planning phase]

### When Editing Code
[Guidance for code editing]

### When Reviewing
[Guidance for code review]

## Memory Commands

[Available Lex CLI commands]
```

## Allowed Content Types

### Allowed

- Plain text descriptions
- Markdown formatting (headers, lists, code blocks, emphasis)
- File paths and CLI commands
- Behavioral guidance (how to use Lex features)
- Repository-specific conventions (derived from policy files)

### Not Allowed

- **Model-specific references** (GPT, Claude, Gemini, OpenAI, Anthropic, Google)
- **Mode/persona references** (Senior Dev, Eager PM, etc.)
- **Timestamps or dates** (causes non-determinism)
- **Random values or UUIDs** (causes non-determinism)
- **Environment-specific paths** (absolute paths, user home directories)
- **Sensitive information** (API keys, tokens, credentials)

## Determinism Requirements

The generated file MUST be deterministic:

> Same repo state + same Lex version → identical output

This means:
- No timestamps or dates in content
- No random values or generated IDs
- No environment-dependent information
- Sorted/ordered output where applicable

## Projection Flow

The canonical file flows to host files through **projection**:

```
┌─────────────────────────────────────────┐
│  .smartergpt/instructions/lex.md        │  ← Canonical Source
│  (Single source of truth)               │
└─────────────────────────────────────────┘
                    │
                    │ Projection
                    ▼
┌─────────────────────────────────────────┐
│  Host Files (receive projected blocks)  │
│                                         │
│  • .github/copilot-instructions.md      │
│  • .cursorrules                         │
│  • (other hosts as detected)            │
└─────────────────────────────────────────┘
```

### Projected Block Format

When content is projected to host files, it is wrapped in markers:

```markdown
<!-- LEX:BEGIN -->
<!-- Auto-generated by `lex instructions generate`. Edit via Lex, not by hand. -->

[Content projected from .smartergpt/instructions/lex.md]

<!-- LEX:END -->
```

**Marker Invariant:** Content outside `<!-- LEX:BEGIN -->` / `<!-- LEX:END -->` markers is **never** modified by Lex.

### Host Detection

| Host File | Condition |
|-----------|-----------|
| `.github/copilot-instructions.md` | Created if `.github/` directory exists |
| `.cursorrules` | Updated if file already exists |

## Schema Definition

See `src/shared/config/canonical-instruction-schema.ts` for the Zod schema defining frontmatter validation.

## Example

See `canon/instructions/lex.example.md` for a minimal example template.

## Validation

Files are validated for:

1. **Frontmatter presence** — Must have valid YAML frontmatter
2. **Required fields** — All required frontmatter fields must be present
3. **Model-agnostic** — No vendor names (GPT, Claude, etc.)
4. **Mode-agnostic** — No persona names (Senior Dev, etc.)
5. **Determinism** — No timestamps or random values

## References

- [Lex 2.0.0 Instructions Contract](./lex-2.0.0-instructions-contract.md)
- [.smartergpt Structure Specification](./smartergpt-structure-v1.md)
