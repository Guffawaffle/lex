# AX Error Codes

This document lists all structured error codes used in Lex, following the AX v0.1 Contract (see `docs/specs/AX-CONTRACT.md`).

All errors follow the AXError schema:

```typescript
{
  code: string;           // UPPER_SNAKE_CASE stable identifier
  message: string;        // Human-readable description
  context?: object;       // Optional structured context
  nextActions: string[];  // At least one recovery suggestion
}
```

## Error Code Conventions

Error codes follow the pattern `CATEGORY_SPECIFIC_ERROR`:

- `AUTH_*` - Authentication and authorization errors
- `JWT_*` - JWT token management errors  
- `MCP_*` - MCP protocol and server errors
- `TIMELINE_*` - Timeline command errors
- `MODULE_*` - Module validation errors
- `FRAME_*` - Frame storage and retrieval errors

---

## Authentication Errors (AUTH_*)

### AUTH_GITHUB_TOKEN_FAILED

**Thrown by:** `src/memory/mcp_server/auth/github-provider.ts`

**Description:** Failed to obtain access token from GitHub OAuth flow.

**Context:**
- `clientId` - GitHub OAuth app client ID
- `redirectUri` - Configured redirect URI

**Next Actions:**
1. Verify your GitHub OAuth app configuration
2. Check that client_id and client_secret are correct
3. Ensure the authorization code is valid and not expired
4. Check GitHub OAuth app settings at https://github.com/settings/developers

---

### AUTH_GITHUB_NO_EMAIL

**Thrown by:** `src/memory/mcp_server/auth/github-provider.ts`

**Description:** GitHub user account has no verified email address.

**Context:**
- `userId` - GitHub user ID
- `login` - GitHub username

**Next Actions:**
1. Add a verified email to your GitHub account
2. Make your primary email public in GitHub settings
3. Grant the 'user:email' scope in OAuth permissions

---

## JWT Errors (JWT_*)

### JWT_PRIVATE_KEY_NOT_FOUND

**Thrown by:** `src/memory/mcp_server/auth/keys.ts`

**Description:** JWT private key file not found at the expected path.

**Context:**
- `privateKeyPath` - Expected file path for private key

**Next Actions:**
1. Run initializeKeys() to generate a new key pair
2. Verify the path is correct
3. Check file permissions on the keys directory

---

### JWT_PUBLIC_KEY_NOT_FOUND

**Thrown by:** `src/memory/mcp_server/auth/keys.ts`

**Description:** JWT public key file not found at the expected path.

**Context:**
- `publicKeyPath` - Expected file path for public key

**Next Actions:**
1. Run initializeKeys() to generate a new key pair
2. Verify the path is correct
3. Check file permissions on the keys directory

---

### JWT_INVALID_TOKEN

**Thrown by:** `src/memory/mcp_server/auth/jwt.ts`

**Description:** JWT token failed verification (invalid signature, malformed, etc).

**Context:**
- `errorType` - Original JWT error type
- `originalMessage` - Original error message

**Next Actions:**
1. Verify the token was generated by this server
2. Check that the JWT signing keys match
3. Ensure the token hasn't been tampered with

---

### JWT_TOKEN_EXPIRED

**Thrown by:** `src/memory/mcp_server/auth/jwt.ts`

**Description:** JWT token has expired and is no longer valid.

**Context:**
- `expiredAt` - Timestamp when the token expired

**Next Actions:**
1. Request a new access token using your refresh token
2. Re-authenticate with OAuth2 to get a new token pair

---

## MCP Server Errors (MCP_*)

### MCP_AUTH_REQUIRED

**Thrown by:** `src/memory/mcp_server/http-server.ts`

**Description:** HTTP server cannot start without authentication configured.

**Context:**
- `enableOAuth` - Whether OAuth2 is enabled
- `hasApiKey` - Whether API key is configured

**Next Actions:**
1. Set enableOAuth: true to enable OAuth2 authentication
2. Or provide an API key via the apiKey option
3. For local development, use MCP stdio mode (no HTTP server needed)
4. See SECURITY.md for deployment best practices

---

### MCP_RECALL_MISSING_PARAMS

**Thrown by:** `src/memory/mcp_server/server.ts`

**Description:** lex.recall tool called without any search parameters.

**Context:**
- `providedParams` - Object showing which params were provided (all undefined/null)

**Next Actions:**
1. Provide a reference_point to search by text
2. Provide a jira ticket ID to filter by Jira ticket
3. Provide a branch name to filter by git branch

---

## Timeline Errors (TIMELINE_*)

### TIMELINE_NO_FRAMES

**Thrown by:** `src/shared/cli/timeline.ts`

**Description:** No frames found matching the query (ticket or branch).

**Context:**
- `query` - The search query (ticket ID or branch name)

**Next Actions:**
1. Try using a Jira ticket ID (e.g., TICKET-123)
2. Try using a branch name
3. Run 'lex remember' to create a frame first

---

### TIMELINE_NO_FRAMES_IN_RANGE

**Thrown by:** `src/shared/cli/timeline.ts`

**Description:** Frames exist for the query, but none fall within the specified time range.

**Context:**
- `query` - The search query
- `since` - Start of time range (if provided)
- `until` - End of time range (if provided)
- `totalFrames` - Total frames found (before filtering)

**Next Actions:**
1. Expand the time range using --since and --until
2. Remove time filters to see all frames
3. Run 'lex remember' to create frames in the desired range

---

### TIMELINE_ERROR

**Thrown by:** `src/shared/cli/timeline.ts`

**Description:** Unexpected error during timeline generation or rendering.

**Context:**
- `query` - The search query
- `error` - Original error details

**Next Actions:**
1. Check that the database is accessible
2. Verify frame data integrity
3. Report this error if it persists

---

## Module Validation Errors (MODULE_*)

### MODULE_VALIDATION_FAILED

**Thrown by:** `src/shared/cli/remember.ts`

**Description:** One or more module IDs in module_scope are invalid or unknown.

**Context:**
- `invalidModules` - List of invalid module IDs
- `suggestions` - Suggested corrections (if available)

**Next Actions:**
1. Check module IDs against lexmap.policy.json
2. Use suggested corrections if provided
3. Run 'lex check' to validate policy compliance

---

## Frame Storage Errors (FRAME_*)

### FRAME_STORE_FAILED

**Thrown by:** `src/shared/cli/remember.ts`

**Description:** Failed to save frame to the database.

**Context:**
- `error` - Original error details

**Next Actions:**
1. Check database file permissions
2. Verify disk space is available
3. Check SQLite database integrity

---

### MISSING_REQUIRED_PARAMS

**Thrown by:** `src/shared/cli/remember.ts`

**Description:** Required parameters missing from lex remember command.

**Context:**
- `missing` - List of missing parameter names

**Next Actions:**
1. Provide all required parameters
2. See 'lex remember --help' for usage
3. Example: lex remember "ref" "summary" --modules "mod1,mod2" --next "action"

---

## Error Handling Best Practices

### For Library/Tool Developers

1. **Always use AXErrorException for throwable errors**
   ```typescript
   throw new AXErrorException(
     "ERROR_CODE",
     "Clear message",
     ["Action 1", "Action 2"],
     { key: "value" }
   );
   ```

2. **Choose stable error codes**
   - Use UPPER_SNAKE_CASE
   - Document in this file when adding new codes
   - Never change existing codes (add new ones instead)

3. **Provide actionable nextActions**
   - At least one action required
   - Be specific and actionable
   - Order by likelihood of success

4. **Include helpful context**
   - Add relevant IDs, paths, values
   - Avoid sensitive data (passwords, tokens)
   - Keep context structured (no nested errors)

### For Error Consumers

1. **Check error codes, not messages**
   ```typescript
   if (isAXErrorException(error)) {
     if (error.axError.code === "JWT_TOKEN_EXPIRED") {
       // Handle expiration
     }
   }
   ```

2. **Present nextActions to users**
   - Show them in CLI output
   - Display in UI as action buttons
   - Log them for debugging

3. **Use context for diagnostics**
   - Include in error logs
   - Help debug user issues
   - Track error patterns

---

## Related Documentation

- [AX Contract v0.1](./specs/AX-CONTRACT.md) - Error structure requirements
- [API Errors](./API_ERRORS.md) - HTTP API error codes
- [Error Types](../src/shared/errors/ax-error.ts) - TypeScript schema

---

**Last Updated:** 2024-12-03  
**AX Version:** v0.1
