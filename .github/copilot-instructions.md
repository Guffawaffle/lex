# GitHub Copilot Instructions for Lex

<!-- LEX:BEGIN -->
<!-- This block is auto-generated by `lex instructions generate`. Do not edit manually. -->

# Lex Instructions (Canonical Source)

> **This file is the canonical source of AI assistant guidance for this repository.**
> Content from here is projected to host files (e.g., `.github/copilot-instructions.md`).

---

## The Lex vs LexRunner Separation

**Before editing schemas, Frames, or `lex.yaml`, read:**
- [`docs/FOUNDERS_NOTE.md`](../../docs/FOUNDERS_NOTE.md) ‚Äî The philosophy
- [`docs/CONTRACT_SURFACE.md`](../../docs/CONTRACT_SURFACE.md) ‚Äî The contract surface (v1)

**Key distinction:**
- **Lex** is the constitution ‚Äî contracts, schemas, memory, policy primitives
- **LexRunner** is one government ‚Äî an implementation that happens to be built by the same author

Do not leak LexRunner-specific behavior into Lex's open contracts. If you're unsure whether something belongs in Lex (the contract layer) or LexRunner (the implementation), default to keeping it out of Lex.

---

## What Lex Does in This Repository

Lex provides the contract layer for AI-assisted development:

- **Memory (Frames):** Immutable episodic context with defined schema
- **Policy:** Module ownership, dependency rules, kill patterns
- **Instructions:** Canonical source ‚Üí host-specific projections
- **Atlas:** Code structure mapping

---

## Key Files

| File | Purpose |
|------|---------|
| `lexmap.policy.json` | Module ownership and dependency policy |
| `**/CONTRACT.md` | Frozen interface contracts ‚Äî do not modify without explicit approval |
| `.smartergpt/` | Local workspace (gitignored, ephemeral) |
| `lex.yaml` | Configuration for instruction generation |
| `docs/FOUNDERS_NOTE.md` | Philosophy: Lex = constitution, LexRunner = government |
| `docs/CONTRACT_SURFACE.md` | What runners must respect to be Lex-compatible |

---

## Situational Guidance

### When Planning Work

1. Check `lex recall "topic"` for prior context
2. Review `lex timeline` for recent work history
3. Read policy files before proposing architectural changes

### When Editing Code

1. Respect module boundaries in `lexmap.policy.json`
2. Honor frozen contracts (`CONTRACT.md` files)
3. Use `lex remember` to capture important context

### When Editing Lex Contracts

**Be especially careful.** Lex contracts are the stable surface that other tools target.

1. Read `docs/FOUNDERS_NOTE.md` first
2. Do not add LexRunner-specific knobs to `lex.yaml` or Frame schemas
3. Breaking changes require a major version bump
4. Document changes in `docs/CONTRACT_SURFACE.md`

---

## Memory Commands

```bash
# Store context for future sessions
lex remember --reference-point "feature-name" --summary "What was accomplished"

# Retrieve relevant context
lex recall "search query"

# View recent work history
lex timeline

# Check policy compliance
lex check
```

---

## Notes

- This file is regenerated by `lex instructions generate`
- Manual edits will be overwritten
- Customize behavior via `lex.yaml` configuration

---

*‚Äî Written by Lex, Signed by Joe (Guffawaffle), November 2025*

<!-- LEX:END -->

---

## üé≠ Personas (Callable AI Modes)

**Activate personas using natural language triggers.** When a user says one of the activation phrases, switch to that persona mode immediately.

### Senior Dev Persona
**Activation Triggers:** "ok senior dev", "act as senior dev", "senior dev mode", "@senior-dev"

**Load:** [`.smartergpt/personas/senior-dev.md`](../.smartergpt/personas/senior-dev.md)

**Summary:** Implementation-focused engineer. Small diffs, tests first, never force-push. Gates: lint, test, build.

### Eager PM Persona
**Activation Triggers:** "ok eager pm", "act as eager pm", "pm mode", "@eager-pm"

**Load:** [`.smartergpt/personas/eager-pm.md`](../.smartergpt/personas/eager-pm.md)

**Summary:** Planning-focused project manager. DMAIC structure, version contracts, issue fan-out in waves.

### Persona Behavior
- When activated, print the session ritual (e.g., "SENIOR-DEV READY (Lex)")
- Stay in persona until explicitly deactivated or session ends
- Respect persona invariants and forbidden actions
- Use persona-specific decision style

---

## ‚ö†Ô∏è CRITICAL: NO GIT COMMANDS IN TESTS ‚ö†Ô∏è

**This is the most important rule in this codebase.**

Tests MUST NOT execute `git commit` or any command chain that might invoke it.

### Why

This development environment uses **mandatory interactive GPG signing** for all git commits.
Any test that spawns `git commit` will:
- Hang indefinitely waiting for GPG passphrase
- Crash the test runner
- Potentially crash WSL2

### What Is Forbidden

```typescript
// ‚ùå NEVER generate this in test code
execSync("git commit -m 'test'");
execSync("git init && git add . && git commit -m 'init'");
spawnSync("git", ["commit", "-m", "test"]);
execSync("git config commit.gpgsign false"); // Even this doesn't help
```

### Quarantined Git Tests

Tests requiring git are:
- Excluded from `npm test`
- Located in `test/shared/git/`
- Run via `npm run test:git` only

---

## Build & Test

```bash
npm ci              # Install deps
npm run build       # Build
npm run check-sqlite # Verify native bindings (run after npm ci or Node upgrade)
npm test            # Run tests (excludes git tests)
npm run lint        # Lint
npm run local-ci    # Full CI (excludes git tests)
npm run test:git    # Git tests ONLY (requires non-interactive git signing)
```

**Important:** `npm run local-ci` executes the full CI pipeline but **excludes git tests**. Git tests are quarantined and should NEVER run in CI or via `npm test`.

### Native SQLite Bindings

Lex uses native SQLite bindings that must match your Node.js version. If tests fail in bulk:

```bash
npm run check-sqlite   # Diagnose binding health
npm run rebuild-sqlite # Fix: recompile for current Node
```

**Doctrine:** We treat broken bindings as a failing gate, not a shrug. See [`docs/dev/sqlite-bindings.md`](../docs/dev/sqlite-bindings.md) for full details.

---

## üß† Lex Memory (Use This!)

**When you learn something worth preserving, use Lex to remember it.**

### Quick Commands

```bash
# Remember something (creates a Frame)
lex remember \
  --summary "What you learned" \
  --modules "memory/store" \
  --next "What to do with this knowledge"

# Recall before starting related work
lex recall "sqlite"

# See available module scopes
cat canon/policy/lexmap.policy.json | jq '.modules | keys'
```

### When to Use

- **Discovered a gotcha** ‚Üí `lex remember` with `--keywords`
- **Starting work on a module** ‚Üí `lex recall` for prior context
- **Debugging took > 30 mins** ‚Üí Document the solution as a Frame

### Module Scopes (Quick Reference)

| Scope | What it covers |
|-------|----------------|
| `memory/store` | SQLite, Frame persistence |
| `memory/frames` | Frame types and operations |
| `shared/atlas` | Code graph, fold radius |
| `cli` | CLI commands |
| `policy/check` | Policy validation |

**Full list:** `cat canon/policy/lexmap.policy.json | jq '.modules | keys'`

---

## Code Style

- TypeScript only in `src/`
- Zod for runtime validation
- Node.js built-in test runner
- ESM modules (.js extensions in imports)

## Architecture

- `src/memory/` - Frame storage, MCP server
- `src/policy/` - Policy validation
- `src/shared/` - Utilities, CLI
- `canon/` - Source prompts/schemas
- `rules/` - Behavioral rules (JSON)

## Commits

- Must be GPG-signed
- Imperative mood: "Add...", "Fix...", "Update..."
- Reference issues: "Fixes #123"

---

## ‚ö†Ô∏è SQL Safety (Curated Queries Only) ‚ö†Ô∏è

**This is a critical rule for database code.**

All SQL must live in curated modules. No dynamic SQL from models, prompts, or application logic.

### Curated SQL Modules

Only these files may contain `db.prepare()` calls:

```
src/memory/store/queries.ts         # Frame CRUD
src/memory/store/code-unit-queries.ts  # CodeUnit CRUD
src/memory/store/receipt-queries.ts  # Receipt CRUD and aggregation
src/memory/store/db.ts              # Schema initialization
src/memory/store/backup.ts          # Backup utilities
src/memory/store/code-atlas-runs.ts # CodeAtlas run tracking
src/memory/store/images.ts          # Image storage
src/memory/mcp_server/auth/         # OAuth state storage
src/memory/mcp_server/routes/       # MCP route handlers
src/shared/cli/db.ts                # CLI database utilities
```

### What Is Forbidden

```typescript
// ‚ùå NEVER do this - dynamic SQL from user input
const sql = `SELECT * FROM frames WHERE ${userInput}`;
db.prepare(sql).all();

// ‚ùå NEVER do this - SQL in application logic
// (belongs in curated query module instead)
function myFeature() {
  db.prepare("SELECT * FROM frames").all();
}

// ‚ùå NEVER do this - dynamic table names
const table = getTableName();
db.prepare(`SELECT * FROM ${table}`).all();
```

### What Is Allowed

```typescript
// ‚úÖ Use curated query modules
import { getFrameById, searchFrames } from '../store/queries.js';
const frame = getFrameById(db, frameId);

// ‚úÖ Parameterized queries in curated modules
// (inside src/memory/store/queries.ts)
const stmt = db.prepare("SELECT * FROM frames WHERE id = ?");
return stmt.get(frameId);
```

### Migrations

Schema changes go in `migrations/` with numbered SQL files:
- Schema changes only (CREATE TABLE, ALTER TABLE, CREATE INDEX)
- Data migrations require explicit review and approval
- See `migrations/README.md` for rules

### CI Enforcement

The `test/sql-safety.test.ts` test enforces these rules:
- Fails if `db.prepare()` appears outside curated modules
- Runs as part of `npm test`

---

## ‚ö†Ô∏è IP Boundary (Lex ‚Üí lex-pr-runner) ‚ö†Ô∏è

**This is a critical rule for maintaining library independence.**

Lex is a **public MIT library**. It must never import from or depend on lex-pr-runner.

### The Boundary

- **Lex (this repo):** Public library, standalone, MIT licensed
- **lex-pr-runner:** Private tool that imports FROM Lex, never the reverse

### What Is Forbidden

```typescript
// ‚ùå NEVER import from lex-pr-runner
import { anything } from "lex-pr-runner";
import { anything } from "@smartergpt/lex-pr-runner";

// ‚ùå NEVER add as dependency
// In package.json:
// "dependencies": { "lex-pr-runner": "..." }  // FORBIDDEN
```

### CI Enforcement

The `test/ip-boundary.test.ts` test enforces this:
- Scans all source files for forbidden imports
- Checks package.json for forbidden dependencies
- Runs as part of `npm test`
