# GitHub Copilot Instructions for Lex

<!-- LEX:BEGIN -->
<!-- This block is auto-generated by `lex instructions generate`. Do not edit manually. -->

# Lex Instructions

> **Use Lex Memory.** Before starting work, run `lex recall "topic"` to retrieve prior context.

## Core Commands

```bash
lex recall "topic"     # Retrieve relevant context before work
lex remember           # Store context after completing work
lex timeline           # View recent work history
lex check              # Validate policy compliance
```

## Key Principle

**Lex is the constitution, not the government.** Schemas, contracts, and memory are stable surfaces. Don't leak implementation details into them.

## Quick Links

- `docs/FOUNDERS_NOTE.md` ‚Äî Philosophy
- `docs/CONTRACT_SURFACE.md` ‚Äî Contract surface (v1)
- `canon/policy/lexmap.policy.json` ‚Äî Module boundaries

---

*Run `lex recall` for detailed guidance on any topic.*

<!-- LEX:END -->

---

## üîê Admin Authority

Copilot agents have delegated `--admin` merge authority when local CI passes.
Run `lex recall "admin authority"` for conditions.

---

## üé≠ Behavioral Layer (LexSona)

Persona execution is handled by **LexSona** (separate package).
Lex provides the behavioral memory socket (`recordCorrection`, `getRules`).

For persona-based workflows, see LexSona documentation.

---

## ‚ö†Ô∏è Critical Rules

Run `lex recall` for detailed guidance on:
- `lex recall "git tests"` ‚Äî NO git commits in tests (GPG signing hangs)
- `lex recall "sql safety"` ‚Äî Curated query modules only (see TROUBLESHOOTING.md "SQL Safety Violations")
- `lex recall "ip boundary"` ‚Äî Lex never imports from lexrunner

**SQL Safety Quick Reference:**
- All `db.prepare()` calls must be in curated query modules (see `test/sql-safety.test.ts`)
- If you get a SQL safety test failure, see `TROUBLESHOOTING.md` for refactor examples
- Never use string interpolation for SQL queries - always use parameterized queries

---

## üèóÔ∏è TypeScript Composite Projects

This repo uses TypeScript **project references** (composite projects). When adding new `.ts` files:

1. **Check the nearest `tsconfig.json`** in parent directories
2. **Add new files to the `include` array** if not covered by existing patterns
3. **Add `references`** if importing from other subdirectories

Example: Adding `src/memory/newfile.ts`:
```bash
# Check which tsconfig owns this directory
cat src/memory/store/tsconfig.json

# Add to include if needed:
# "include": ["*.ts", "**/*.ts", "../newfile.ts"]
```

**Why?** Without this, builds fail with TS6307: "File not listed within project".

---

## Build & Test

```bash
npm ci && npm run build && npm test && npm run lint
npm run local-ci  # Full CI pipeline
```

If SQLite tests fail: `npm run rebuild-sqlite`
