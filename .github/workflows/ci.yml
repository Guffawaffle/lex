# Minimal CI: lint + typecheck only
# To run full CI: use workflow_dispatch with 'level' input
# Local equivalents:
#   minimal: npm run ci:minimal
#   standard: npm run ci
#   full: npm run ci:full
name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      level:
        description: 'CI level to run'
        required: false
        type: choice
        options:
          - minimal
          - standard
          - full
        default: 'minimal'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # Stage 0: Verify Commit Signatures (MANDATORY - always runs)
  verify-signatures:
    name: Verify Signatures
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          disable-sudo: true

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Import GPG keys
        run: |
          echo "${{ secrets.TRUSTED_GPG_KEYS }}" | base64 -d | gpg --import

      - name: Verify commit signatures
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            COMMIT_RANGE="${{ github.event.pull_request.base.sha }}..${{ github.sha }}"
          else
            COMMIT_RANGE="${{ github.event.before }}..${{ github.sha }}"
          fi
          echo "Verifying commits in range: $COMMIT_RANGE"
          UNSIGNED_COMMITS=""
          for commit in $(git log --format="%H" $COMMIT_RANGE); do
            if ! git verify-commit $commit 2>/dev/null; then
              UNSIGNED_COMMITS="$UNSIGNED_COMMITS $commit"
            fi
          done
          if [ -n "$UNSIGNED_COMMITS" ]; then
            echo "❌ Unsigned commits found:"
            for commit in $UNSIGNED_COMMITS; do
              git log --format="%H %an <%ae> %s" -n 1 $commit
            done
            exit 1
          fi
          echo "✅ All commits signed"

  # Minimal gates: lint + typecheck (always runs)
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: verify-signatures
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci --ignore-scripts
      - run: npm run lint

  typecheck:
    name: TypeCheck
    runs-on: ubuntu-latest
    needs: verify-signatures
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci --ignore-scripts
      - run: npm run build
      - run: npm run type-check

  # Standard gates: build + tests (only on workflow_dispatch with level >= standard)
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    if: >-
      github.event_name == 'workflow_dispatch' && 
      (inputs.level == 'standard' || inputs.level == 'full')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci --ignore-scripts
      - run: npm rebuild better-sqlite3
      - run: npm run setup-local
      - run: npm run build
      - run: npm run validate-schemas
      - run: npm run coverage

  # Full gates: integration tests (only on workflow_dispatch with level == full)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    if: >-
      github.event_name == 'workflow_dispatch' && inputs.level == 'full'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci --ignore-scripts
      - run: npm rebuild better-sqlite3
      - run: npm run setup-local
      - run: npm run build
      - run: npm run test:integration

  # Package validation (only on full)
  validate-packages:
    name: Validate Packages
    runs-on: ubuntu-latest
    needs: build-and-test
    if: >-
      github.event_name == 'workflow_dispatch' && inputs.level == 'full'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci --ignore-scripts
      - run: npm run setup-local
      - run: npm run build
      - run: npm run guard:pack

  # Summary job
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [verify-signatures, lint, typecheck]
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.verify-signatures.result }}" != "success" ]]; then
            echo "❌ Signature verification failed"; exit 1
          fi
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "❌ Lint failed"; exit 1
          fi
          if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
            echo "❌ TypeCheck failed"; exit 1
          fi
          echo "✅ CI Complete (level: ${{ inputs.level || 'minimal' }})"
