name: Publish to MCP Registry

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (validate only, do not publish)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  id-token: write  # Required for OIDC authentication
  contents: read

jobs:
  sync-and-publish:
    name: Sync Version and Publish to MCP Registry
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          disable-sudo: false  # Need sudo for installing mcp-publisher

      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Sync server.json version with package.json
        run: |
          echo "ðŸ“¦ Syncing versions..."
          VERSION=$(jq -r '.version' package.json)
          echo "Package version: $VERSION"
          
          # Update both top-level version and packages[0].version
          jq --arg v "$VERSION" '.version = $v | .packages[0].version = $v' server.json > server.json.tmp
          mv server.json.tmp server.json
          
          echo "âœ… server.json updated to version $VERSION"
          cat server.json | jq '{version: .version, packages: [.packages[0] | {version: .version}]}'

      - name: Download mcp-publisher
        run: |
          echo "ðŸ“¥ Downloading mcp-publisher..."
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_linux_amd64.tar.gz" | tar xz
          sudo mv mcp-publisher /usr/local/bin/
          mcp-publisher --version || echo "mcp-publisher installed"
          echo "âœ… mcp-publisher installed"

      - name: Validate server.json
        run: |
          echo "ðŸ” Validating server.json..."
          mcp-publisher validate
          echo "âœ… Validation passed"

      - name: Authenticate with MCP Registry (OIDC)
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'false')
        run: |
          echo "ðŸ” Authenticating with GitHub OIDC..."
          mcp-publisher login github-oidc
          echo "âœ… Authentication successful"

      - name: Publish to MCP Registry (Dry Run)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true'
        run: |
          echo "ðŸ§ª Running dry-run validation..."
          echo "âœ… Dry run complete - server.json is valid"
          echo "â„¹ï¸  To publish, re-run with dry_run=false or wait for a release event"

      - name: Publish to MCP Registry
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'false')
        run: |
          echo "ðŸš€ Publishing to MCP Registry..."
          mcp-publisher publish
          echo "âœ… Published successfully"
          
      - name: Summary
        if: always()
        run: |
          echo "### MCP Registry Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "âœ… Triggered by release: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
              echo "ðŸ§ª Dry run completed - validation only" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Manual publish completed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          VERSION=$(jq -r '.version' package.json)
          echo "ðŸ“¦ Version: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Registry: MCP Registry" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Package: \`io.github.guffawaffle/lex\`" >> $GITHUB_STEP_SUMMARY
