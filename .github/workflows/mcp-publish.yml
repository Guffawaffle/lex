name: Publish to MCP Registry

# SECURITY: Runs ONLY on release tags or explicit manual trigger with reviewer approval
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (validate only, do not publish)"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

# MINIMAL PERMISSIONS: No id-token needed for DNS auth (uses private key signing)
permissions:
  contents: read

jobs:
  # Job 1: Validate (no protected environment - runs on all triggers)
  validate:
    name: Validate server.json
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          disable-sudo: false

      - uses: actions/checkout@v6

      - name: Validate trigger (release tags only for auto-publish)
        if: github.event_name == 'release'
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "âŒ Invalid release tag format: $TAG"
            echo "Expected: v{major}.{minor}.{patch} or v{major}.{minor}.{patch}-{prerelease}"
            exit 1
          fi
          echo "âœ… Valid release tag: $TAG"

      - name: Get version
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Package version: $VERSION"

      - name: Verify release tag matches package.json version
        if: github.event_name == 'release'
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${{ steps.version.outputs.version }}"
          # Strip 'v' prefix from tag for comparison
          TAG_VERSION="${TAG#v}"
          if [ "$TAG_VERSION" != "$VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "   Release tag: $TAG (version: $TAG_VERSION)"
            echo "   package.json: $VERSION"
            echo ""
            echo "Fix: Update package.json to $TAG_VERSION before releasing,"
            echo "     or create a release with tag v$VERSION"
            exit 1
          fi
          echo "âœ… Release tag v$VERSION matches package.json version $VERSION"

      - name: Sync server.json version with package.json
        run: |
          echo "ðŸ“¦ Syncing versions..."
          VERSION="${{ steps.version.outputs.version }}"

          # Update both top-level version and packages[0].version
          jq --arg v "$VERSION" '.version = $v | .packages[0].version = $v' server.json > server.json.tmp
          mv server.json.tmp server.json

          echo "âœ… server.json updated to version $VERSION"
          cat server.json | jq '{name: .name, version: .version, packages: [.packages[0] | {version: .version, identifier: .identifier}]}'

      - name: Download mcp-publisher
        run: |
          echo "ðŸ“¥ Downloading mcp-publisher..."
          curl -fsSL "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_linux_amd64.tar.gz" | tar xz
          sudo mv mcp-publisher /usr/local/bin/
          mcp-publisher --help | head -5
          echo "âœ… mcp-publisher installed"

      - name: Validate server.json schema
        run: |
          echo "ðŸ” Validating server.json..."
          # Check JSON is valid
          if ! jq empty server.json 2>/dev/null; then
            echo "âŒ server.json is not valid JSON"
            exit 1
          fi
          # Check required fields exist
          NAME=$(jq -r '.name' server.json)
          VERSION=$(jq -r '.version' server.json)
          IDENTIFIER=$(jq -r '.packages[0].identifier' server.json)
          if [ -z "$NAME" ] || [ "$NAME" = "null" ]; then
            echo "âŒ server.json missing 'name' field"
            exit 1
          fi
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "âŒ server.json missing 'version' field"
            exit 1
          fi
          if [ -z "$IDENTIFIER" ] || [ "$IDENTIFIER" = "null" ]; then
            echo "âŒ server.json missing 'packages[0].identifier' field"
            exit 1
          fi
          echo "âœ… server.json validated: $NAME v$VERSION ($IDENTIFIER)"

      - name: Check if should publish
        id: check
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.dry_run }}" = "false" ]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

      - name: Dry Run Summary
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true'
        run: |
          echo "ðŸ§ª Dry run complete - server.json is valid"
          echo "â„¹ï¸  To publish:"
          echo "   - Re-run this workflow with dry_run=false, OR"
          echo "   - Create a GitHub Release (triggers auto-publish)"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### MCP Registry Validation (Dry Run)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§ª Dry run completed - validation only" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Version: \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Server: \`dev.smartergpt/lex\`" >> $GITHUB_STEP_SUMMARY

  # Job 2: Publish (protected environment - requires reviewer approval)
  publish:
    name: Publish to MCP Registry
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_publish == 'true'
    environment: mcp-publish
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          disable-sudo: false

      - uses: actions/checkout@v6

      - name: Sync server.json version
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          jq --arg v "$VERSION" '.version = $v | .packages[0].version = $v' server.json > server.json.tmp
          mv server.json.tmp server.json
          echo "âœ… server.json synced to version $VERSION"

      - name: Download mcp-publisher
        run: |
          curl -fsSL "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_linux_amd64.tar.gz" | tar xz
          sudo mv mcp-publisher /usr/local/bin/

      # DNS Authentication with Ed25519 private key
      # SECURITY: Private key is never echoed; uses proper quoting
      - name: Authenticate with MCP Registry (DNS)
        env:
          MCP_REGISTRY_PRIVATE_KEY_HEX: ${{ secrets.MCP_REGISTRY_PRIVATE_KEY_HEX }}
        run: |
          echo "ðŸ” Authenticating with DNS verification (smartergpt.dev)..."
          mcp-publisher login dns --domain "smartergpt.dev" --private-key "${MCP_REGISTRY_PRIVATE_KEY_HEX}"
          echo "âœ… Authentication successful"

      - name: Publish to MCP Registry
        run: |
          echo "ðŸš€ Publishing to MCP Registry..."
          mcp-publisher publish
          echo "âœ… Published successfully to registry.modelcontextprotocol.io"

      - name: Summary
        if: always()
        run: |
          echo "### MCP Registry Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "âœ… Triggered by release: \`${{ github.event.release.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Manual publish completed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Version: \`${{ needs.validate.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Registry: MCP Registry (registry.modelcontextprotocol.io)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Server: \`dev.smartergpt/lex\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”‘ Auth: DNS (smartergpt.dev TXT record)" >> $GITHUB_STEP_SUMMARY
