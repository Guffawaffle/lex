name: Alias Resolution Tests

on:
  pull_request:
    branches: [ main, staging ]
  push:
    branches: [ main, staging ]
  workflow_dispatch:

# Limit permissions to read-only by default
permissions:
  contents: read

jobs:
  test-aliases:
    name: Alias Tests (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ['20', '22']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'

      - name: Install dependencies (hermetic)
        run: npm ci --ignore-scripts

      - name: Initialize working files
        run: npm run setup-local

      - name: Build
        run: npm run build

      - name: Run alias resolution tests
        run: npm run test:aliases

      - name: Check alias test coverage
        if: matrix.node == '20'
        run: |
          c8 --reporter=text \
             --reporter=json-summary \
             --include=src/shared/aliases/**/*.ts \
             --include=src/shared/aliases/**/*.mts \
             --exclude=**/*.test.* \
             --exclude=**/*.spec.* \
             npm run test:aliases

      - name: Verify coverage requirements (90%+)
        if: matrix.node == '20'
        run: |
          c8 --check-coverage \
             --branches 90 \
             --functions 90 \
             --lines 90 \
             --statements 90 \
             --include=src/shared/aliases/**/*.ts \
             --include=src/shared/aliases/**/*.mts \
             --exclude=**/*.test.* \
             --exclude=**/*.spec.* \
             npm run test:aliases

      - name: Upload coverage report
        if: matrix.node == '20'
        uses: actions/upload-artifact@v4
        with:
          name: alias-coverage-report
          path: |
            coverage/
            coverage-summary.json

  validate-snapshots:
    name: Validate Snapshots
    runs-on: ubuntu-latest
    needs: test-aliases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (hermetic)
        run: npm ci --ignore-scripts

      - name: Initialize working files
        run: npm run setup-local

      - name: Build
        run: npm run build

      - name: Run snapshot tests
        run: node --test src/shared/aliases/resolution.spec.mjs

      - name: Check for uncommitted snapshot changes
        run: |
          if git diff --exit-code src/shared/aliases/__snapshots__/; then
            echo "✅ Snapshots are up to date"
          else
            echo "❌ Snapshot changes detected but not committed"
            echo "Run: LEX_UPDATE_SNAPSHOTS=1 npm run test:aliases"
            echo "Then commit the updated snapshots"
            git diff src/shared/aliases/__snapshots__/
            exit 1
          fi

  lint-alias-table:
    name: Lint Alias Table
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (hermetic)
        run: npm ci --ignore-scripts

      - name: Build
        run: npm run build

      - name: Lint alias table for case sensitivity
        run: node scripts/lint-alias-table.mjs

  test-summary:
    name: Alias Tests Summary
    runs-on: ubuntu-latest
    needs: [test-aliases, validate-snapshots, lint-alias-table]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Alias Resolution Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Alias Tests: ${{ needs.test-aliases.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Snapshot Validation: ${{ needs.validate-snapshots.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Alias Table Linting: ${{ needs.lint-alias-table.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Substring/pattern matching: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Collision detection: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Case sensitivity: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Snapshot regression: ✅" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any tests failed
        if: |
          needs.test-aliases.result == 'failure' ||
          needs.validate-snapshots.result == 'failure' ||
          needs.lint-alias-table.result == 'failure'
        run: exit 1
