name: Test Suite

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build all packages
      run: npm run build
      
    - name: Run unit tests
      run: npm test

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build all packages
      run: npm run build
      
    - name: Run memory integration tests
      run: cd memory && npx tsx --test integration.test.ts
      
    - name: Run MCP server integration tests
      run: cd memory/mcp_server && npm run build && node --test dist/integration.test.js
      
    - name: Run policy integration tests
      run: cd policy && node integration.test.mjs

  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    # Only run on main branch to avoid slowing down PRs
    if: github.ref == 'refs/heads/main'
    needs: integration-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build all packages
      run: npm run build
      
    - name: Run performance benchmarks
      run: cd memory && npx tsx --test benchmarks.test.ts

  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build all packages
      run: npm run build
      
    - name: Generate coverage report
      run: |
        npm test 2>&1 | tee test-output.txt || true
        echo "## Test Coverage Summary" > coverage-summary.md
        echo "" >> coverage-summary.md
        echo "Target: >80% coverage" >> coverage-summary.md
        echo "" >> coverage-summary.md
        echo "### Test Results" >> coverage-summary.md
        grep -E "(pass|fail|tests)" test-output.txt >> coverage-summary.md || echo "No test results found" >> coverage-summary.md
        
    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('coverage-summary.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()
    
    steps:
    - name: Check test results
      run: |
        echo "## Test Suite Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ Unit tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "✅ Integration tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        
    - name: Fail if tests failed
      if: needs.unit-tests.result == 'failure' || needs.integration-tests.result == 'failure'
      run: exit 1
